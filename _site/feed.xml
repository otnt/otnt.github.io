<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Pufan Jiang&#39;s Blog</title>
    <description>Pufan Jiang&#39;s personal blog, including lots of tech blogs, photo shooting etc.</description>
    <link>http://huangxuan.me/</link>
    <atom:link href="http://huangxuan.me/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Thu, 11 Feb 2016 20:44:21 -0500</pubDate>
    <lastBuildDate>Thu, 11 Feb 2016 20:44:21 -0500</lastBuildDate>
    <generator>Jekyll v2.4.0</generator>
    
      <item>
        <title>Poison Pill Pattern</title>
        <description>&lt;h1 id=&quot;poison-pill-pattern&quot;&gt;Poison Pill Pattern&lt;/h1&gt;

&lt;h3 id=&quot;why-need-this&quot;&gt;Why need this?&lt;/h3&gt;
&lt;p&gt;In a producer consumer problem, how could threads know when to stop? If just interrupt all threads abruptly, maybe some jobs in the queue are not handled properly. So we want to find a way to tell all threads that you should stop, and stop decently.&lt;/p&gt;

&lt;h3 id=&quot;how-it-works&quot;&gt;How it works?&lt;/h3&gt;
&lt;p&gt;The idea is extremely simple. When producer wants to stop the service, it sends a special message (poison pill) into the queue and stops it self, when consumer gets this message, it closes it self as well.&lt;/p&gt;

&lt;h3 id=&quot;what-if-multiply-producers-and-multiply-consumers&quot;&gt;What if multiply producers and multiply consumers?&lt;/h3&gt;
&lt;ol&gt;
  &lt;li&gt;If only one producer and consumer, then it’s totally fine.&lt;/li&gt;
  &lt;li&gt;If there are several producers and one consumer, each producer could send a poison pill to consumer and stop itself. When consumer gets same number of poison pills, then it stop running.&lt;/li&gt;
  &lt;li&gt;If there are one producer and several consumers, then producer send poison pills of same number as consumers to queue. Each consumer stops itself when get a poison pill.&lt;/li&gt;
  &lt;li&gt;If there are multiple producers and multiple consumers, then each producer send poison pill of same number as consumers to queue. Each consumer stops itself when get poison pills of same number as producer.&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;what-is-the-problem&quot;&gt;What is the problem?&lt;/h3&gt;
&lt;p&gt;This solution suppose producers and consumers know the quantity of each other.&lt;br /&gt;
Also, if we have N producers and M consumers, then number of poison pills will be N*M, which could be large.&lt;/p&gt;

&lt;h3 id=&quot;alternative-solution&quot;&gt;Alternative Solution&lt;/h3&gt;
&lt;p&gt;One alternative solution is we relax the constraints so that consumers could also offer messages into queue, but only when it is trying to stop the whole service.&lt;br /&gt;
On producers’ side, when all producers are going to leave the service, the last producer send a poison pill to the queue. This could be done by several ways, one way is to elect a leader so the leader send the poison pill and then every producer leaves.&lt;br /&gt;
On consumers’ side, when any of consumers get a poison pill, it first the poison pill back to queue and leave the service. So that all consumers will finally leave the service.&lt;br /&gt;
This solution is based on that producers know each other, and consumers know each other, but producers and consumers don’t know each other, which makes more sense in real world.&lt;/p&gt;

&lt;h3 id=&quot;reference&quot;&gt;Reference&lt;/h3&gt;
&lt;ol&gt;
  &lt;li&gt;“Poison Pill Shutdown” in Java Concurrency in Practice&lt;/li&gt;
&lt;/ol&gt;
</description>
        <pubDate>Thu, 11 Feb 2016 14:37:00 -0500</pubDate>
        <link>http://huangxuan.me/2016/02/11/poison-pill-pattern/</link>
        <guid isPermaLink="true">http://huangxuan.me/2016/02/11/poison-pill-pattern/</guid>
        
        <category>Design Pattern</category>
        
        <category>Multi-thread</category>
        
        <category>Producer Consumer</category>
        
        
      </item>
    
  </channel>
</rss>
